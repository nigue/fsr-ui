<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="alerts" class="alerts-container">
    <!-- Alerta de éxito al guardar umbrales -->
    <div class="alert alert-success alert-dismissible fade show" id="thresholds-saved-alert" style="display: none;">
        <strong>¡Éxito!</strong> Umbrales guardados en el dispositivo exitosamente.
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>

    <!-- Alerta de perfil guardado -->
    <div class="alert alert-success alert-dismissible fade show" id="profile-saved-alert" style="display: none;">
        <strong>¡Éxito!</strong> Perfil guardado exitosamente.
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>

    <!-- Alerta de conexión WebSocket -->
    <div class="alert alert-warning alert-dismissible fade show" id="connection-alert" style="display: none;">
        <strong>Conexión:</strong> <span id="connection-status">Desconectado</span>
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>

    <!-- Alerta de error -->
    <div class="alert alert-danger alert-dismissible fade show" id="error-alert" style="display: none;">
        <strong>Error:</strong> <span id="error-message">Ocurrió un error</span>
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>

    <!-- Alerta informativa -->
    <div class="alert alert-info alert-dismissible fade show" id="info-alert" style="display: none;">
        <strong>Información:</strong> <span id="info-message">Mensaje informativo</span>
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
</div>

<script>
    // Sistema de alertas global
    class AlertManager {
        constructor() {
            this.alerts = {
                success: document.getElementById('thresholds-saved-alert'),
                profile: document.getElementById('profile-saved-alert'),
                connection: document.getElementById('connection-alert'),
                error: document.getElementById('error-alert'),
                info: document.getElementById('info-alert')
            };

            this.connectionStatus = document.getElementById('connection-status');
            this.errorMessage = document.getElementById('error-message');
            this.infoMessage = document.getElementById('info-message');
        }

        showAlert(type, message = null) {
            // Ocultar todas las alertas primero
            this.hideAllAlerts();

            const alert = this.alerts[type];
            if (alert) {
                if (message && this[type + 'Message']) {
                    this[type + 'Message'].textContent = message;
                }
                alert.style.display = 'block';

                // Auto-ocultar después de 5 segundos para alertas de éxito
                if (type === 'success' || type === 'profile') {
                    setTimeout(() => {
                        this.hideAlert(type);
                    }, 5000);
                }
            }
        }

        hideAlert(type) {
            const alert = this.alerts[type];
            if (alert) {
                alert.style.display = 'none';
            }
        }

        hideAllAlerts() {
            Object.values(this.alerts).forEach(alert => {
                alert.style.display = 'none';
            });
        }

        showConnectionStatus(connected) {
            this.connectionStatus.textContent = connected ? 'Conectado' : 'Desconectado';
            this.showAlert('connection');

            // Cambiar clase según estado
            const connectionAlert = this.alerts.connection;
            connectionAlert.className = connected ?
                'alert alert-success alert-dismissible fade show' :
                'alert alert-warning alert-dismissible fade show';
        }

        showError(message) {
            this.errorMessage.textContent = message;
            this.showAlert('error');
        }

        showInfo(message) {
            this.infoMessage.textContent = message;
            this.showAlert('info');
        }
    }

    // Instancia global
    const alertManager = new AlertManager();

    // Integración con WebSocket
    document.addEventListener('DOMContentLoaded', function() {
        // Escuchar eventos de conexión
        fsrWebSocket.on('connect', function() {
            alertManager.showConnectionStatus(true);
        });

        fsrWebSocket.on('disconnect', function() {
            alertManager.showConnectionStatus(false);
        });

        // Escuchar eventos del sistema FSR
        fsrWebSocket.on('thresholds_persisted', function(msg) {
            alertManager.showAlert('success');
        });

        fsrWebSocket.on('error', function(msg) {
            alertManager.showError(msg);
        });

        // Manejar errores de WebSocket
        if (window.fsrWebSocket) {
            const originalOnError = window.fsrWebSocket.ws.onerror;
            window.fsrWebSocket.ws.onerror = function(error) {
                alertManager.showError('Error de conexión WebSocket');
                if (originalOnError) originalOnError(error);
            };
        }
    });
</script>

</html>