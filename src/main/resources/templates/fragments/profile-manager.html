<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="profile-manager" class="profile-manager">
    <!-- Dropdown de perfiles -->
    <div class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-toggle="dropdown">
            Perfiles
        </a>
        <div class="dropdown-menu" id="profile-dropdown">
            <!-- Perfiles generados dinámicamente por JavaScript -->
        </div>
    </div>

    <!-- Formulario para añadir perfil -->
    <form class="form-inline" id="add-profile-form">
        <input class="form-control" type="text" id="new-profile-name" placeholder="Nuevo Perfil" />
        <button class="btn btn-primary ml-2" type="submit">Añadir</button>
    </form>

    <!-- Alerta de perfil guardado -->
    <div class="alert alert-success alert-dismissible fade show" id="profile-saved-alert" style="display: none;">
        Perfil guardado exitosamente!
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const profileDropdown = document.getElementById('profile-dropdown');
        const addProfileForm = document.getElementById('add-profile-form');
        const newProfileInput = document.getElementById('new-profile-name');
        const profileSavedAlert = document.getElementById('profile-saved-alert');

        function safeEmit(payload) {
            if (window.fsrWebSocket && typeof window.fsrWebSocket.emit === 'function') {
                try {
                    // proteger contra this.websocket undefined dentro de emit
                    window.fsrWebSocket.emit(payload);
                } catch (e) {
                    console.error('[profile-manager] emit fallo:', e, payload);
                }
            } else {
                console.warn('[profile-manager] fsrWebSocket no listo, payload descartado:', payload);
            }
        }

        function updateProfileList(profiles, activeProfile) {
            profileDropdown.innerHTML = '';
            profiles.forEach(function(profile) {
                const isActive = profile === activeProfile;
                const item = document.createElement('a');
                item.className = 'dropdown-item' + (isActive ? ' active' : '');
                item.href = '#';
                item.innerHTML = `<button class="btn btn-sm btn-light mr-2" onclick="removeProfile('${profile}')">X</button>${profile}`;
                item.onclick = function(e) {
                    e.preventDefault();
                    if (!e.target.closest('button')) {
                        changeProfile(profile);
                    }
                };
                profileDropdown.appendChild(item);
            });
        }

        addProfileForm.addEventListener('submit', function(e) {
            console.log('addProfileForm addEventListener submit');
            e.preventDefault();
            const profileName = newProfileInput.value.trim();
            console.log('[profile-manager] submit fired, profileName=', profileName);
            if (profileName) {
                const thresholds = getCurrentThresholds();
                console.log('[profile-manager] emitting add_profile, thresholds=', thresholds);
                safeEmit(['add_profile', profileName, thresholds]);
                newProfileInput.value = '';
            }
        });

        window.removeProfile = function(profileName) {
            console.log('[profile-manager] removeProfile called:', profileName);
            if (confirm('¿Eliminar perfil "' + profileName + '"?')) {
                safeEmit(['remove_profile', profileName]);
            }
        };

        window.changeProfile = function(profileName) {
            console.log('[profile-manager] changeProfile called:', profileName);
            safeEmit(['change_profile', profileName]);
        };

        function getCurrentThresholds() {
            const thresholds = [];
            document.querySelectorAll('.threshold-label').forEach(function(label) {
                thresholds.push(parseInt(label.textContent));
            });
            console.log('[profile-manager] getCurrentThresholds ->', thresholds);
            return thresholds;
        }

        // Escuchar eventos WebSocket si el objeto ya está disponible
        if (window.fsrWebSocket && typeof window.fsrWebSocket.on === 'function') {
            window.fsrWebSocket.on('get_profiles', function(msg) {
                updateProfileList(msg.profiles, msg.cur_profile || '');
            });
            window.fsrWebSocket.on('get_cur_profile', function(msg) {
                document.querySelectorAll('#profile-dropdown .dropdown-item').forEach(function(item) {
                    item.classList.remove('active');
                });
            });
            window.fsrWebSocket.on('thresholds_persisted', function(msg) {
                profileSavedAlert.style.display = 'block';
                setTimeout(function() { profileSavedAlert.style.display = 'none'; }, 3000);
            });
        } else {
            console.warn('[profile-manager] fsrWebSocket no definido aún. Asegúrate de incluir el script del WebSocket antes de este fragmento o exponer un evento cuando esté listo.');
        }
    });
</script>



</html>